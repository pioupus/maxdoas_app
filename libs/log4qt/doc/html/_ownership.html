<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Log4Qt: Object ownership</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>Object ownership </h1>  </div>
</div>
<div class="contents">
<p>In difference to the JAVA Log4j package Log4Qt must manage ownership and lifetime of the objects used. This is non trivial as objects are created and used in different ways.</p>
<p>In general an object can be created explicitly for example an application may create Loggers, Appenders and Layouts during creation of a QApplication object. But they can also be automatically created by the package on startup using a <a class="el" href="class_log4_qt_1_1_property_configurator.html">PropertyConfigurator</a> configuration file. Objects may also be created the one way and then used the other. Object may be used by multiple other objects. A Layout for example may be used by multiple Appenders. Objects are also created from multiple threads. The creation may happen during static initialisation and the deletion during static de-initialization.</p>
<p>The parent child model used by QObject cannot be used to handle this. It cannot automatically delete an object that is used by multiple others as for example an Appender used by multiple Loggers. In addition to this QObjects and their children must reside in the same thread. This would either mean to impose restriction on how objects can be created or to move objects to a specific thread.</p>
<p>To allow an automatic deletion of not required objects the package implements reference counting for Appenders, Layouts and Filters. The reference counting is implemented in <a class="el" href="class_log4_qt_1_1_log_object.html">LogObject</a>, which is used as a common base class. The reference count can be explicitly changed using the methods <a class="el" href="class_log4_qt_1_1_log_object.html#a387650baf4007eaddd54bae639679f0c">retain()</a> and <a class="el" href="class_log4_qt_1_1_log_object.html#a65cda1be1ddbc2e00185d9e3369f30ee">release()</a>. Alternatively an auto pointer is available <a class="el" href="class_log4_qt_1_1_log_object_ptr.html">LogObjectPtr</a>, which is used throughout the package.</p>
<p>The reference counting mechanism will test, if an object has a QObject parent object set. If a parent is set, the object will not be deleted, if the reference count reaches 0. This allows to mix the reference counted paradigm with the QObject parent child one.</p>
<p>The following example configures a logger and uses reference counting to manage the ownership of objects.</p>
<div class="fragment"><pre class="fragment"> <span class="comment">// Create layout</span>
 TTCCLayout *p_layout = <span class="keyword">new</span> TTCCLayout();

 <span class="comment">// Create appender</span>
 ConsoleAppender *p_appender = <span class="keyword">new</span> ConsoleAppender(p_layout, ConsoleAppender::STDOUT_TARGET);
 p_appender-&gt;activateOptions();

 <span class="comment">// Get logger</span>
 Logger *p_logger = Logger::logger(<span class="stringliteral">&quot;MyClass&quot;</span>);
 p_logger-&gt;addAppender(p_appender);

 <span class="comment">// ...</span>

 <span class="comment">// Remove appender from Logger</span>
 p_logger-&gt;removeAllAppenders(); <span class="comment">// p_appender and p_layout are deleted here</span>
</pre></div><p>The following example configures a logger and uses QObject ownership of objects.</p>
<div class="fragment"><pre class="fragment"> QObject *p_parent = <span class="keyword">new</span> MyObject;

 <span class="comment">// Create objects</span>
 ConsoleAppender *p_appender = <span class="keyword">new</span> ConsoleAppender(p_parent);
 TTCCLayout *p_layout = <span class="keyword">new</span> TTCCLayout(p_appender);

 <span class="comment">// Configure appender</span>
 p_appender-&gt;setTarget(ConsoleAppender::STDOUT_TARGET);
 p_appender-&gt;setLayout(p_layout);
 p_appender-&gt;activateOptions();

 <span class="comment">// Get logger</span>
 Logger *p_logger = Logger::logger(<span class="stringliteral">&quot;MyClass&quot;</span>);
 p_logger-&gt;addAppender(p_appender);

 <span class="comment">// ...</span>

 <span class="comment">// Remove appender from Logger</span>
 p_logger-&gt;removeAllAppenders();

 <span class="keyword">delete</span> p_parent; <span class="comment">// p_appender and p_layout are deleted here</span>
</pre></div><p>The following example shows how to use objects created on the stack.</p>
<div class="fragment"><pre class="fragment"> {
     <span class="comment">// Create layout</span>
     TTCCLayout layout;
     layout.retain();

     <span class="comment">// Create appender</span>
     ConsoleAppender appender(&amp;layout, ConsoleAppender::STDOUT_TARGET);
     appender.retain();
     appender.activateOptions();

     <span class="comment">// Get logger</span>
     Logger *p_logger = Logger::logger(<span class="stringliteral">&quot;MyClass&quot;</span>);
     p_logger-&gt;addAppender(&amp;appender);

     <span class="comment">// ...</span>

     <span class="comment">// Remove appender from Logger</span>
     p_logger-&gt;removeAllAppenders(); <span class="comment">// Without retain() program crashes here</span>

 } <span class="comment">// p_appender and p_layout are deleted here</span>
</pre></div> </div>
<hr class="footer"/><address class="footer"><small>Generated on Fri May 27 2011 17:14:39 for Log4Qt by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
